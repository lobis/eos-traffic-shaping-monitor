// ----------------------------------------------------------------------------
// File: TrafficShaping.proto
// Author: Luis Antonio Obis Aparicio <luis.obis@cern.ch>
// ----------------------------------------------------------------------------

syntax = "proto3";

package eos.rpc;

option go_package = "eos_traffic_shaping_monitor/proto";

service Eos {
  rpc TrafficShapingRate(TrafficShapingRateRequest) returns (stream TrafficShapingRateResponse) {}
}

message TrafficShapingRateRequest {
  enum Estimators {
    UNSPECIFIED = 0; // Proto3 best practice (default 0 should be no-op)
    // SMA
    SMA_5_SECONDS = 1;
    SMA_1_MINUTES = 2;
    SMA_5_MINUTES = 3;
    // EMA
    EMA_5_SECONDS = 4;
    EMA_1_MINUTES = 5;
    EMA_5_MINUTES = 6;
  }
  repeated Estimators estimators = 1;

  enum EntityType {
    ENTITY_UNSPECIFIED = 0;
    ENTITY_APP = 1;
    ENTITY_UID = 2;
    ENTITY_GID = 3;
  }
  repeated EntityType include_types = 2;

  // How many top entries to return for each type? (e.g., Top 10 apps)
  optional uint32 top_n = 3;

  // --- 4. Sorting Ambiguity Resolver ---
  // If I ask for 5s and 5m windows, which one determines who is in the "Top 10"?
  // (e.g., Sort by 5m trend, but show me the 1s spikes too)
  optional Estimators sort_by_estimator = 4;
}

// --- Response Definition ---

message TrafficShapingRateResponse {
  int64 timestamp_ms = 1;

  // These are only filled if requested in RateRequest
  repeated AppRateEntry app_stats = 2;
  repeated UserRateEntry user_stats = 3;
  repeated GroupRateEntry group_stats = 4;
}


message AppRateEntry {
  string app_name = 1;
  // CHANGE THIS: Add 'repeated'
  repeated RateStats stats = 2;
}

message UserRateEntry {
  uint32 uid = 1;
  // CHANGE THIS: Add 'repeated'
  repeated RateStats stats = 2;
}

message GroupRateEntry {
  uint32 gid = 1;
  // CHANGE THIS: Add 'repeated'
  repeated RateStats stats = 2;
}

message RateStats {
  TrafficShapingRateRequest.Estimators window = 1;

  double bytes_read_per_sec = 2;
  double bytes_written_per_sec = 3;
  double iops_read = 4;
  double iops_write = 5;
}
